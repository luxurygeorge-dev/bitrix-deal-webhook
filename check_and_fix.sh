#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ–±—Ö—É–∫–∞
# –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

echo "=== –ü–†–û–í–ï–†–ö–ê –í–ï–ë–•–£–ö–ê ==="
echo "–í—Ä–µ–º—è: $(date)"
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞:"
if systemctl is-active --quiet bitrix_deal_webhook.service; then
    echo "   ‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
else
    echo "   ‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    echo "   üîÑ –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å..."
    systemctl start bitrix_deal_webhook.service
    sleep 5
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:"
response=$(curl -s -o /dev/null -w "%{http_code}" http://188.225.24.13:5000/health 2>/dev/null)
if [ "$response" = "200" ]; then
    echo "   ‚úÖ –í–µ–±—Ö—É–∫ –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "   ‚ùå –í–µ–±—Ö—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–∫–æ–¥: $response)"
    echo "   üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å..."
    systemctl restart bitrix_deal_webhook.service
    sleep 10
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:"
response=$(curl -s -o /dev/null -w "%{http_code}" http://188.225.24.13:5000/health 2>/dev/null)
if [ "$response" = "200" ]; then
    echo "   ‚úÖ –í–µ–±—Ö—É–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "   ‚ùå –í–µ–±—Ö—É–∫ –≤—Å–µ –µ—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
echo "4. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
journalctl -u bitrix_deal_webhook.service -n 3 --no-pager

echo
echo "=== –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ==="


