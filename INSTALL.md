# Быстрая установка и настройка

## Шаг 1: Подготовка Битрикс24

### 1.1 Создайте пользовательские поля для сделок

В админке Битрикс24:
1. Перейдите в **CRM → Настройки → Пользовательские поля → Сделки**
2. Создайте два поля:

**Поле 1: "Причина отказа"**
- Тип: Текст или Список
- Символьный код: `UF_CRM_REJECTION_REASON`
- Обязательное: Нет

**Поле 2: "История причин отказов"**
- Тип: Текст (многострочный)
- Символьный код: `UF_CRM_REJECTION_HISTORY`
- Обязательное: Нет

### 1.2 Создайте входящий вебхук

1. **Приложения → Разработчикам → Другое → Входящий вебхук**
2. Выберите права: **CRM (crm)**
3. Скопируйте URL вебхука (например: `https://yourcompany.bitrix24.ru/rest/1/xxxxxxxxxx/`)

## Шаг 2: Настройка сервера

### 2.1 Скопируйте конфигурацию
```bash
cd /root/projects/bitrix_deal_webhook
cp config.env.example .env
nano .env
```

### 2.2 Заполните настройки в .env файле
```env
# Ваш URL вебхука из п. 1.2
BITRIX_WEBHOOK_URL=https://yourcompany.bitrix24.ru/rest/1/xxxxxxxxxx

# Поля (обычно менять не нужно)
REJECTION_REASON_FIELD=UF_CRM_REJECTION_REASON
REJECTION_HISTORY_FIELD=UF_CRM_REJECTION_HISTORY
MAX_FIELD_LENGTH=2000
```

### 2.3 Проверьте настройку
```bash
python test_setup.py
```

Все тесты должны пройти успешно.

## Шаг 3: Запуск

### Запуск в продакшне
```bash
./run.sh
```

Сервер будет доступен на порту 5000.

### Проверка работы
```bash
curl http://your-server.com:5000/health
```

## Шаг 4: Настройка обработчика событий в Битрикс24

1. **Приложения → Разработчикам → Другое → Обработчики событий**
2. Создайте обработчик:
   - **Событие**: `ONCRMDEALADD`
   - **Обработчик**: `http://your-server.com:5000/webhook/deal`
   - **Пользователь**: выберите пользователя с правами на CRM

## Готово!

Теперь при создании новой сделки система автоматически:
1. Найдет все предыдущие сделки контакта
2. Извлечет причины отказов из проигранных сделок
3. Запишет их в поле "История причин отказов" новой сделки

## Тестирование

Создайте тестовую сделку в Битрикс24 для контакта, у которого есть предыдущие проигранные сделки с заполненными причинами отказов.

## Логи

Проверить работу можно в логах:
```bash
tail -f /root/projects/bitrix_deal_webhook/webhook.log
```

